function simulation(){window.requestAnimFrame(simulation);var t=(thisLoop=new Date)-lastLoop;frameTime+=(t-frameTime)/filterStrength,lastLoop=thisLoop,fluid.update()}var song=new Audio;song.src="Instruments.m4a",song.autoplay=!0,document.getElementById("wrapper").appendChild(song),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}();var NavierStokes=function(t){this.init(t)};NavierStokes.prototype={init:function(t){var s={resolution:256,iterations:3,fract:.25,diffusion:.99,gridmodify:0,dt:.3,callbackUser:function(t,s,i,e){},callbackDisplay:function(t,s,i,e){}};void 0===this.settings&&(this.settings=s),this._mergeRecursive(this.settings,t),this.rows=this.settings.resolution+2,this.arraySize=(this.settings.resolution+2)*(this.settings.resolution+2),this.U=new Float32Array(this.arraySize),this.V=new Float32Array(this.arraySize),this.D=new Float32Array(this.arraySize),this.U_prev=new Float32Array(this.arraySize),this.V_prev=new Float32Array(this.arraySize),this.D_prev=new Float32Array(this.arraySize),this.NullArray=new Float32Array(this.arraySize),this.IX=new Array(this.rows);for(var i=0;i<this.rows;i++){this.IX[i]=new Array(this.rows);for(var e=0;e<this.rows;e++)this.IX[i][e]=i+e*this.rows}for(i=0;i<this.arraySize;i++)this.D_prev[i]=this.U_prev[i]=this.V_prev[i]=this.D[i]=this.U[i]=this.V[i]=this.NullArray[i]=0;this.calculateSettings()},clear:function(){this.D.set(this.NullArray),this.U.set(this.NullArray),this.V.set(this.NullArray)},getResolution:function(){return this.settings.resolution},getSettings:function(){return this.settings},update:function(){this.userAction(),this.vel_step(this.U,this.V,this.U_prev,this.V_prev,this.settings.dt),this.dens_step(this.D,this.D_prev,this.U,this.V,this.settings.dt),this.settings.callbackDisplay(this.D,this.U,this.V,this.settings.resolution)},calculateSettings:function(){this.centerPos=-.5/this.settings.resolution*(1+this.settings.gridmodify),this.scale=.5*this.settings.resolution,this.dt0=this.settings.dt*this.settings.resolution,this.p5=this.settings.resolution+.5},userAction:function(){this.D_prev.set(this.NullArray),this.U_prev.set(this.NullArray),this.V_prev.set(this.NullArray),this.settings.callbackUser(this.D_prev,this.U_prev,this.V_prev,this.settings.resolution)},vel_step:function(t,s,i,e,n){var o;this.add_source(t,i,n),this.add_source(s,e,n),o=i,i=t,t=o,this.diffuse(1,t,i,n),o=e,e=s,s=o,this.diffuse(2,s,e,n),this.project(t,s,i,e),o=i,i=t,t=o,o=e,e=s,s=o,this.advect(1,t,i,i,e,n),this.advect(2,s,e,i,e,n),this.project(t,s,i,e)},dens_step:function(t,s,i,e,n){this.add_source(t,s,n),this.diffuse(0,s,t,n),this.advect(0,t,s,i,e,n)},add_source:function(t,s,i){for(var e=0;e<this.arraySize;e++)t[e]+=i*s[e]},diffuse:function(t,s,i,e){for(var n=1;n<this.arraySize;n++)s[n]=i[n]*this.settings.diffusion;this.set_bnd(t,s)},project:function(t,s,i,e){var n,o,h,a,r,u,l;for(n=1;n<=this.settings.resolution;n++)for(h=this.IX[0][n-1],a=this.IX[0][n],r=this.IX[0][n+1],valueBefore=a-1,valueNext=a+1,u=this.settings.resolution+valueNext,o=valueNext;o<u;o++)i[o]=0,e[o]=(t[++valueNext]-t[++valueBefore]+s[++r]-s[++h])*this.centerPos;for(this.set_bnd(0,e),this.set_bnd(0,i),o=0;o<this.settings.iterations;o++){for(j=1;j<=this.settings.resolution;j++)for(l=this.IX[0][j-1],a=this.IX[0][j],r=this.IX[0][j+1],prevX=i[a],a++,n=1;n<=this.settings.resolution;n++)i[a]=prevX=(e[a]+i[++l]+i[++a]+i[++r]+prevX)*this.settings.fract;this.set_bnd(0,i)}for(j=1;j<=this.settings.resolution;j++)for(l=this.IX[0][j-1],a=this.IX[0][j],r=this.IX[0][j+1],valueBefore=a-1,valueNext=a+1,n=1;n<=this.settings.resolution;n++)t[++a]-=this.scale*(i[++valueNext]-i[++valueBefore]),s[a]-=this.scale*(i[++r]-i[++l]);this.set_bnd(1,t),this.set_bnd(2,s)},advect:function(t,s,i,e,n,o){for(var h=1;h<=this.settings.resolution;h++)for(var a=h*this.rows,r=1;r<=this.settings.resolution;r++){var u=r-this.dt0*e[++a],l=h-this.dt0*n[a];u<.5&&(u=.5),u>this.p5&&(u=this.p5);var c=0|u,f=c+1;l<.5&&(l=.5),l>this.p5&&(l=this.p5);var d=0|l,g=d+1,v=u-c,m=1-v,p=l-d,w=1-p,y=this.IX[0][d],I=this.IX[0][g];s[a]=m*(w*i[c+y]+p*i[c+I])+v*(w*i[f+y]+p*i[f+I])}this.set_bnd(t,s)},set_bnd:function(t,s){var i;switch(t){case 1:for(i=1;i<=this.settings.resolution;i++)s[i]=s[i+this.rows],s[this.IX[i][this.settings.resolution+1]]=s[this.IX[i][this.settings.resolution]],s[this.IX[0][i]]=-s[this.IX[1][i]],s[this.IX[this.settings.resolution+1][i]]=-s[this.IX[this.settings.resolution][i]];break;case 2:for(i=1;i<=this.settings.resolution;i++)s[i]=-s[i+this.rows],s[this.IX[i][this.settings.resolution+1]]=-s[this.IX[i][this.settings.resolution]],s[this.IX[0][i]]=s[this.IX[1][i]],s[this.IX[this.settings.resolution+1][i]]=s[this.IX[this.settings.resolution][i]];break;default:for(i=1;i<=this.settings.resolution;i++)s[i]=s[i+this.rows],s[this.IX[i][this.settings.resolution+1]]=s[this.IX[i][this.settings.resolution]],s[this.IX[0][i]]=s[this.IX[1][i]],s[this.IX[this.settings.resolution+1][i]]=s[this.IX[this.settings.resolution][i]]}var e=this.IX[0][this.settings.resolution+1];s[0]=(s[1]+s[this.rows])/2,s[e]=(s[1+e]+s[this.IX[this.settings.resolution][0]])/2,s[this.settings.resolution+1]=(s[this.settings.resolution]+s[this.settings.resolution+1+this.rows])/2,s[this.settings.resolution+1+e]=s[this.settings.resolution+e]+s[this.IX[this.settings.resolution+1][this.settings.resolution]]},_mergeRecursive:function(t,s){for(var i in s)s[i].constructor==Object?t[i]=this._mergeRecursive(t[i],s[i]):t[i]=s[i];return t}};var Display=function(t){this.colorFunctions={BW:this.calcColorBW,Color:this.calcColor,User:this.calcUserColor},this.currColorFunc="User",this.canvas=t,this.context=t.getContext("2d",{alpha:!1}),this.supportImageData=!!this.context.getImageData,this.colorUser={R:50,G:50,B:50}};Display.prototype={init:function(t){this.calcResolution=t,this.imageData=null,this.showColors=!1,this.line=null},density:function(t,s,i){var e,n;if(this.supportImageData){for(null===this.imageData&&(this.imageData=this.context.getImageData(0,0,this.calcResolution,this.calcResolution)),e=0;e<this.calcResolution;e++)for(n=0;n<this.calcResolution;n++){var o=4*(e+n*this.calcResolution),h=fluid.IX[e][n],a=this.colorFunctions[this.currColorFunc].call(this,t,s,i,h);this.imageData.data[o]=a[0],this.imageData.data[o+1]=a[1],this.imageData.data[o+2]=a[2],this.imageData.data[o+3]=255}this.context.putImageData(this.imageData,0,0)}else for(e=0;e<this.calcResolution;e++)for(n=0;n<this.calcResolution;n++){var h=fluid.IX[e][n],r=t[h]/2;this.context.setFillColor(r,r,r,1),this.context.fillRect(e,n,1,1)}null!=this.line&&(this.context.beginPath(),this.context.lineWidth=1,this.context.strokeStyle="rgb(255,255,255)",this.context.moveTo(this.line[0][0],this.line[0][1]),this.context.lineTo(this.line[1][0],this.line[1][1]),this.context.stroke())},setColorFunction:function(t){this.currColorFunc="BW"},calcColorBW:function(t,s,i,e){var n=255*t[e]/6|0;return[n,n,n]},calcColor:function(t,s,i,e){var n=Math.abs(1300*s[e]|0),o=Math.abs(1300*i[e]|0),h=255*t[e]/6|0;return[n,h,o]},calcUserColor:function(t,s,i,e){var n=Math.abs(500*s[e]*this.colorUser.R|0),o=t[e]*this.colorUser.G|0,h=Math.abs(500*i[e]*this.colorUser.B|0);return[n,o,h]},drawLine:function(t,s,i){var e=[t[0]*i,t[1]*i],n=[s[0]*i,s[1]*i];this.line=[e,n]},removeLine:function(){this.line=null}};var user={displaySize:500,canvas:null,canvasOffset:null,scale:0,mouseStart:[],mouseEnd:[],mouseLeftDown:!1,mousePath:[],mouseRightDown:!1,mouseRightStart:[],forceEmitters:[],insertedDensity:50,init:function(t){this.canvas=$(t),this.canvasOffset=this.canvas.offset();var s=this;window.ontouchend=window.onmouseup=function(t){s.handleInputEnd(t)},t.ontouchstart=t.onmousedown=function(t){s.handleInput(t)},t.ontouchmove=t.onmousemove=function(t){s.handleInputMove(t)},t.oncontextmenu=function(t){t.preventDefault()},t.ontouchstart=function(t){s.handleInput(t)},t.ontouchmove=function(t){s.handleInputMove(t)},window.ontouchend=function(t){s.handleInputEnd(t)}},interact:function(t,s,i,e){var n,o,h,a;if(this.mouseLeftDown){var r=this.mouseStart[0]-this.mouseEnd[0],u=this.mouseStart[1]-this.mouseEnd[1],l=0|Math.sqrt(r*r+u*u);for(l=l<1?1:l,a=0;a<l;a++)n=(this.mouseStart[0]-a/l*r)*this.scale|0,o=(this.mouseStart[1]-a/l*u)*this.scale|0,h=fluid.IX[n][o],s[h]=-r/6,i[h]=-u/6,t[h]=this.insertedDensity;this.mouseStart[0]=this.mouseEnd[0],this.mouseStart[1]=this.mouseEnd[1]}for(a=0;a<this.forceEmitters.length;a++){var c=this.forceEmitters[a],h=fluid.IX[c[0]*this.scale|0][c[1]*this.scale|0];s[h]=c[2],i[h]=c[3]}},initFluidWithResolution:function(){fluid.init(),this.setCanvasSize(fluid.settings.resolution),display.init(fluid.settings.resolution)},clearDisplay:function(){fluid.clear(),this.forceEmitters=[]},setDisplay:function(t){var s=parseInt(t);0===s?this.setDisplaySize(fluid.getSettings().resolution):this.setDisplaySize(s)},setCanvasSize:function(t){this.canvas.attr("width",t),this.canvas.attr("height",t),this.calculateScale()},setDisplaySize:function(t){$("#wrapper").width(t),this.canvas.width(t),this.canvas.height(t),this.calculateScale()},calculateScale:function(){this.scale=fluid.getResolution()/this.canvas.width(),this.canvasOffset=this.canvas.offset()},handleInput:function(t){if("touchstart"===t.type)this.mouseLeftDown=!0,this.mouseEnd=this.mouseStart=[t.pageX-this.canvasOffset.left,t.pageY-this.canvasOffset.top];else if(void 0!==t.button){var s=this.getMousePositon(t);0==t.button?(this.mouseLeftDown=!0,this.mouseEnd=this.mouseStart=s):2==t.button&&(this.mouseRightDown=!0,this.mouseRightStart=s)}t.preventDefault()},handleInputMove:function(t){var s=this.getMousePositon(t);this.mouseLeftDown&&("touchmove"===t.type?this.mouseEnd=[t.pageX-this.canvasOffset.left,t.pageY-this.canvasOffset.top]:this.mouseEnd=s),this.mouseRightDown&&display.drawLine(this.mouseRightStart,s,this.scale)},handleInputEnd:function(t){if(this.mouseLeftDown=!1,this.mouseRightDown){this.mouseRightDown=!1;var s=this.getMousePositon(t),i=this.mouseRightStart[0],e=this.mouseRightStart[1],n=-(i-s[0])/10,o=-(e-s[1])/10;this.forceEmitters.push([i,e,n,o]),display.removeLine()}},getMousePositon:function(t){var s,i;return t.offsetX?(s=t.offsetX,i=t.offsetY):t.layerX&&(s=t.layerX,i=t.layerY),[s,i]}},canvas=document.getElementById("d"),display=new Display(canvas),fluid=new NavierStokes({callbackDisplay:function(t,s,i,e){display.density(t,s,i,e)},callbackUser:function(t,s,i,e){user.interact(t,s,i,e)}});user.init(canvas,fluid,display),user.initFluidWithResolution();var filterStrength=20,frameTime=0,lastLoop=new Date,thisLoop,fpsOut=document.getElementById("fps");simulation();